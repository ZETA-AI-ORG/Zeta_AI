name: üîç V√©rification Modifications IA

on:
  push:
    branches:
      - ia
  pull_request:
    branches:
      - main

jobs:
  verify-changes:
    name: D√©tection des modifications IA
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # R√©cup√©rer tout l'historique
      
      - name: üîç Comparaison avec main
        run: |
          echo "========================================="
          echo "üîç D√âTECTION DES MODIFICATIONS IA"
          echo "========================================="
          echo ""
          
          # R√©cup√©rer la branche main
          git fetch origin main
          
          # Statistiques des changements
          echo "üìä STATISTIQUES:"
          git diff --stat origin/main..HEAD
          echo ""
          
          # Fichiers modifi√©s
          echo "üìù FICHIERS MODIFI√âS:"
          git diff --name-only origin/main..HEAD
          echo ""
          
          # Compter les modifications
          MODIFIED_FILES=$(git diff --name-only origin/main..HEAD | wc -l)
          echo "Total: $MODIFIED_FILES fichiers modifi√©s"
          
          # V√©rifier les fichiers critiques
          echo ""
          echo "‚ö†Ô∏è FICHIERS CRITIQUES MODIFI√âS:"
          git diff --name-only origin/main..HEAD | grep -E "(app\.py|vector_store|rag_engine|smart_metadata)" || echo "Aucun"
      
      - name: üìã R√©sum√© des modifications
        run: |
          echo "========================================="
          echo "üìã R√âSUM√â"
          echo "========================================="
          
          # Additions/Suppressions
          ADDITIONS=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= insertion)')
          DELETIONS=$(git diff --shortstat origin/main..HEAD | grep -oP '\d+(?= deletion)')
          
          echo "‚úÖ Lignes ajout√©es: ${ADDITIONS:-0}"
          echo "‚ùå Lignes supprim√©es: ${DELETIONS:-0}"
          echo ""
          echo "üí° V√©rifiez ces changements avant de fusionner avec main!"
      
      - name: üß™ Tests de s√©curit√© (optionnel)
        run: |
          echo "üß™ V√©rification de la pr√©sence de secrets..."
          
          # V√©rifier qu'aucun secret n'a √©t√© committ√©
          if git diff origin/main..HEAD | grep -iE "(api_key|password|secret|token)" > /dev/null; then
            echo "‚ö†Ô∏è ATTENTION: Possibles secrets d√©tect√©s dans le diff!"
            echo "V√©rifiez manuellement avant de fusionner."
          else
            echo "‚úÖ Aucun secret d√©tect√©"
          fi
