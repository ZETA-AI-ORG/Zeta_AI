{
  "test_name": "Hacker RevisitÃ© - Validation Patches",
  "timestamp": "2025-11-12T22:07:27.274597",
  "duration_seconds": 147.98432,
  "scores": {
    "patch1_limite_mots": 12.5,
    "patch2_redirections": 0.0,
    "patch3_finalisation": 0,
    "patch4_analyse_intention": 0.0,
    "global": 3.125
  },
  "metrics": {
    "total_questions": 10,
    "reponses_courtes": 1,
    "redirections_correctes": 0,
    "finalisation_automatique": false,
    "analyses_intention_correctes": 0
  },
  "verdict": "NON VALIDÃ‰",
  "conversation_history": [
    {
      "role": "user",
      "content": "Salut ! Je veux commander des couches",
      "timestamp": "2025-11-12T22:07:40.305594"
    },
    {
      "role": "assistant",
      "content": "NotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.",
      "timestamp": "2025-11-12T22:07:40.305600"
    },
    {
      "role": "user",
      "content": "Voici la photo du produit",
      "timestamp": "2025-11-12T22:08:39.464192"
    },
    {
      "role": "assistant",
      "content": "Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“",
      "timestamp": "2025-11-12T22:08:39.464196"
    },
    {
      "role": "user",
      "content": "Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?",
      "timestamp": "2025-11-12T22:08:46.266744"
    },
    {
      "role": "assistant",
      "content": "Bonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?",
      "timestamp": "2025-11-12T22:08:46.266751"
    },
    {
      "role": "user",
      "content": "Peux-tu me donner des conseils sur les tailles ?",
      "timestamp": "2025-11-12T22:08:55.370642"
    },
    {
      "role": "assistant",
      "content": "Bien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?",
      "timestamp": "2025-11-12T22:08:55.370650"
    },
    {
      "role": "user",
      "content": "J'ai un problÃ¨me technique avec l'app",
      "timestamp": "2025-11-12T22:09:02.237229"
    },
    {
      "role": "assistant",
      "content": "DÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".",
      "timestamp": "2025-11-12T22:09:02.237234"
    },
    {
      "role": "user",
      "content": "OK je continue ma commande alors",
      "timestamp": "2025-11-12T22:09:07.552034"
    },
    {
      "role": "assistant",
      "content": "Bienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)",
      "timestamp": "2025-11-12T22:09:07.552041"
    },
    {
      "role": "user",
      "content": "Capture de paiement 2500F",
      "timestamp": "2025-11-12T22:09:31.311086"
    },
    {
      "role": "assistant",
      "content": "Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“",
      "timestamp": "2025-11-12T22:09:31.311093"
    },
    {
      "role": "user",
      "content": "Je suis Ã  Yopougon",
      "timestamp": "2025-11-12T22:09:36.788551"
    },
    {
      "role": "assistant",
      "content": "NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©phone ? ğŸ“",
      "timestamp": "2025-11-12T22:09:36.788554"
    },
    {
      "role": "user",
      "content": "Mon numÃ©ro: 0787360757",
      "timestamp": "2025-11-12T22:09:48.101850"
    },
    {
      "role": "assistant",
      "content": "NotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nQuel produit veux-tu acheter ?",
      "timestamp": "2025-11-12T22:09:48.101855"
    },
    {
      "role": "user",
      "content": "Peux-tu modifier le dÃ©lai de livraison ?",
      "timestamp": "2025-11-12T22:09:54.251294"
    },
    {
      "role": "assistant",
      "content": "DÃ©solÃ©, mais pour modifier le dÃ©lai de livraison, nous avons besoin de plus d'informations. Pouvez-vous nous donner le numÃ©ro de commande ou le produit exact que vous avez commandÃ© ?",
      "timestamp": "2025-11-12T22:09:54.251298"
    }
  ],
  "full_system_logs": [
    {
      "step": 1,
      "message": "Salut ! Je veux commander des couches",
      "patch_tested": "Baseline",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "NotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.",
      "timestamp": "2025-11-12T22:07:40.305585"
    },
    {
      "step": 2,
      "message": "Voici la photo du produit",
      "patch_tested": "Baseline",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n",
      "response": "Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“",
      "timestamp": "2025-11-12T22:08:39.464178"
    },
    {
      "step": 3,
      "message": "Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?",
      "patch_tested": "PATCH 2 - Redirections SAV",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "Bonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?",
      "timestamp": "2025-11-12T22:08:46.266734"
    },
    {
      "step": 4,
      "message": "Peux-tu me donner des conseils sur les tailles ?",
      "patch_tested": "PATCH 2 - Redirections SAV",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "Bien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?",
      "timestamp": "2025-11-12T22:08:55.370622"
    },
    {
      "step": 5,
      "message": "J'ai un problÃ¨me technique avec l'app",
      "patch_tested": "PATCH 2 - Redirections SAV",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "DÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".",
      "timestamp": "2025-11-12T22:09:02.237216"
    },
    {
      "step": 6,
      "message": "OK je continue ma commande alors",
      "patch_tested": "PATCH 1 - Limite 15 mots",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "Bienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)",
      "timestamp": "2025-11-12T22:09:07.552025"
    },
    {
      "step": 7,
      "message": "Capture de paiement 2500F",
      "patch_tested": "PATCH 1 - Limite 15 mots",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:12][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 96s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=wI6F404RotMQ7kNvwEnhydb&_nc_oc=AdmqrPkDq5bTSUqR3fv3g0PrvQbXW9_9Frci7xyQgQ0werBvu95Sz_8rw99dCA-tpPzw_VcH2vgb6kW0y9q-RJI2&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-3.xx&oh=03_Q7cD3wFOCg_nyFNqiAFZ2JtXL-o6TYQJotUYQ0L6mr8mM1BA7g&oe=6938095A\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 52806\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981754_botlive_y5ke7tsa.jpg\n[TRACE][22:09:20][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (828, 1792)\n[BLIP-2] ğŸ“ Caption brut: 'a bag of sanitary wipes on a white background'\n[BLIP-2] âœ… Caption nettoyÃ©: 'a bag of sanitary wipes on a white background' (confiance: 0.9)\n[BOTLIVE] BLIP-2 terminÃ©: a bag of sanitary wipes on a white background\n[BOTLIVE] ğŸ“¦ Image dÃ©tectÃ©e: PRODUIT â†’ Pas d'OCR paiement\nğŸ’¾ [NOTEPAD] Photo produit sauvegardÃ©e: a bag of sanitary wipes on a white background\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s photo produit (314 chars)\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: False\n   Total reÃ§u: 0 FCFA\n   Paiements: []\n   Message: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n[BOTLIVE] Analyse (brute): type=unknown, prod=a bag of sanitary wipes on a white background:0.90, ocr_len=0 amts=0\n[BOTLIVE][VISION RAW] raw_text=\n\n[BOTLIVE][VISION RAW] candidate_amounts=[]\n[BOTLIVE][VISION RAW] detected_objects=['objet:a bag of sanitary wipes on a white background~0.90']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[a bag of sanitary wipes on a white background|90%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:a bag of sanitary wipes on a white background~0.90']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâŒ INSUFFISANT: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.90\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCapture de paiement 2500F\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.90\nğŸ’¾ [HYBRID] RÃ©conciliateur a modifiÃ© notepad â†’ Sauvegarde forcÃ©e\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n",
      "response": "Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“",
      "timestamp": "2025-11-12T22:09:31.311058"
    },
    {
      "step": 8,
      "message": "Je suis Ã  Yopougon",
      "patch_tested": "PATCH 1 - Limite 15 mots",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:12][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 96s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=wI6F404RotMQ7kNvwEnhydb&_nc_oc=AdmqrPkDq5bTSUqR3fv3g0PrvQbXW9_9Frci7xyQgQ0werBvu95Sz_8rw99dCA-tpPzw_VcH2vgb6kW0y9q-RJI2&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-3.xx&oh=03_Q7cD3wFOCg_nyFNqiAFZ2JtXL-o6TYQJotUYQ0L6mr8mM1BA7g&oe=6938095A\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 52806\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981754_botlive_y5ke7tsa.jpg\n[TRACE][22:09:20][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (828, 1792)\n[BLIP-2] ğŸ“ Caption brut: 'a bag of sanitary wipes on a white background'\n[BLIP-2] âœ… Caption nettoyÃ©: 'a bag of sanitary wipes on a white background' (confiance: 0.9)\n[BOTLIVE] BLIP-2 terminÃ©: a bag of sanitary wipes on a white background\n[BOTLIVE] ğŸ“¦ Image dÃ©tectÃ©e: PRODUIT â†’ Pas d'OCR paiement\nğŸ’¾ [NOTEPAD] Photo produit sauvegardÃ©e: a bag of sanitary wipes on a white background\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s photo produit (314 chars)\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: False\n   Total reÃ§u: 0 FCFA\n   Paiements: []\n   Message: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n[BOTLIVE] Analyse (brute): type=unknown, prod=a bag of sanitary wipes on a white background:0.90, ocr_len=0 amts=0\n[BOTLIVE][VISION RAW] raw_text=\n\n[BOTLIVE][VISION RAW] candidate_amounts=[]\n[BOTLIVE][VISION RAW] detected_objects=['objet:a bag of sanitary wipes on a white background~0.90']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[a bag of sanitary wipes on a white background|90%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:a bag of sanitary wipes on a white background~0.90']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâŒ INSUFFISANT: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.90\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCapture de paiement 2500F\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.90\nğŸ’¾ [HYBRID] RÃ©conciliateur a modifiÃ© notepad â†’ Sauvegarde forcÃ©e\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (339 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:34][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 119s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\nğŸšš [DELIVERY] Zone dÃ©tectÃ©e: Yopougon = 1500 FCFA\nğŸ“‹ [DELIVERY] Contexte injectÃ© dans le prompt (112 chars)\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4267 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4267 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJe suis Ã  Yopougon\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n",
      "response": "NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©phone ? ğŸ“",
      "timestamp": "2025-11-12T22:09:36.788537"
    },
    {
      "step": 9,
      "message": "Mon numÃ©ro: 0787360757",
      "patch_tested": "PATCH 3 - Finalisation automatique",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:12][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 96s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=wI6F404RotMQ7kNvwEnhydb&_nc_oc=AdmqrPkDq5bTSUqR3fv3g0PrvQbXW9_9Frci7xyQgQ0werBvu95Sz_8rw99dCA-tpPzw_VcH2vgb6kW0y9q-RJI2&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-3.xx&oh=03_Q7cD3wFOCg_nyFNqiAFZ2JtXL-o6TYQJotUYQ0L6mr8mM1BA7g&oe=6938095A\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 52806\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981754_botlive_y5ke7tsa.jpg\n[TRACE][22:09:20][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (828, 1792)\n[BLIP-2] ğŸ“ Caption brut: 'a bag of sanitary wipes on a white background'\n[BLIP-2] âœ… Caption nettoyÃ©: 'a bag of sanitary wipes on a white background' (confiance: 0.9)\n[BOTLIVE] BLIP-2 terminÃ©: a bag of sanitary wipes on a white background\n[BOTLIVE] ğŸ“¦ Image dÃ©tectÃ©e: PRODUIT â†’ Pas d'OCR paiement\nğŸ’¾ [NOTEPAD] Photo produit sauvegardÃ©e: a bag of sanitary wipes on a white background\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s photo produit (314 chars)\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: False\n   Total reÃ§u: 0 FCFA\n   Paiements: []\n   Message: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n[BOTLIVE] Analyse (brute): type=unknown, prod=a bag of sanitary wipes on a white background:0.90, ocr_len=0 amts=0\n[BOTLIVE][VISION RAW] raw_text=\n\n[BOTLIVE][VISION RAW] candidate_amounts=[]\n[BOTLIVE][VISION RAW] detected_objects=['objet:a bag of sanitary wipes on a white background~0.90']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[a bag of sanitary wipes on a white background|90%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:a bag of sanitary wipes on a white background~0.90']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâŒ INSUFFISANT: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.90\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCapture de paiement 2500F\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.90\nğŸ’¾ [HYBRID] RÃ©conciliateur a modifiÃ© notepad â†’ Sauvegarde forcÃ©e\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (339 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:34][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 119s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\nğŸšš [DELIVERY] Zone dÃ©tectÃ©e: Yopougon = 1500 FCFA\nğŸ“‹ [DELIVERY] Contexte injectÃ© dans le prompt (112 chars)\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4267 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4267 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJe suis Ã  Yopougon\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'delivery_zone_date', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (392 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ“ Zone mentionnÃ©e avant: Yopougon (livraison 1500 FCFA)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:40][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 124s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4271 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4271 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nMon numÃ©ro: 0787360757\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: âœ…PARFAIT Commande confirmÃ©e ğŸ˜Š\nLivraison prÃ©vue demain, acompte de 2020 F dÃ©jÃ  versÃ©.\nNous vous rappe...\nğŸ“Š [HYBRID] Source: python_final_recap\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâœ… TÃ©lÃ©phone: 0787360757\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2026 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mMon numÃ©ro: 0787360757\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Mon numÃ©ro: 0787360757\"\nintentions:\n  type: contact\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: \"0787360757\"\n  paiement: null\nnouvelles_donnees:\n  - cle: telephone\n    valeur: \"0787360757\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 50\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: true\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"1/5\"\n  donnees_manquantes: [type_produit, quantite, zone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nQuel produit veux-tu acheter ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 266 | TOTAL: 2026\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001249 ($0.001038 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "NotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nQuel produit veux-tu acheter ?",
      "timestamp": "2025-11-12T22:09:48.101803"
    },
    {
      "step": 10,
      "message": "Peux-tu modifier le dÃ©lai de livraison ?",
      "patch_tested": "PATCH 2+4 - Redirections + Analyse intention",
      "raw_logs": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:12][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 96s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=wI6F404RotMQ7kNvwEnhydb&_nc_oc=AdmqrPkDq5bTSUqR3fv3g0PrvQbXW9_9Frci7xyQgQ0werBvu95Sz_8rw99dCA-tpPzw_VcH2vgb6kW0y9q-RJI2&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-3.xx&oh=03_Q7cD3wFOCg_nyFNqiAFZ2JtXL-o6TYQJotUYQ0L6mr8mM1BA7g&oe=6938095A\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 52806\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981754_botlive_y5ke7tsa.jpg\n[TRACE][22:09:20][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (828, 1792)\n[BLIP-2] ğŸ“ Caption brut: 'a bag of sanitary wipes on a white background'\n[BLIP-2] âœ… Caption nettoyÃ©: 'a bag of sanitary wipes on a white background' (confiance: 0.9)\n[BOTLIVE] BLIP-2 terminÃ©: a bag of sanitary wipes on a white background\n[BOTLIVE] ğŸ“¦ Image dÃ©tectÃ©e: PRODUIT â†’ Pas d'OCR paiement\nğŸ’¾ [NOTEPAD] Photo produit sauvegardÃ©e: a bag of sanitary wipes on a white background\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s photo produit (314 chars)\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: False\n   Total reÃ§u: 0 FCFA\n   Paiements: []\n   Message: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n[BOTLIVE] Analyse (brute): type=unknown, prod=a bag of sanitary wipes on a white background:0.90, ocr_len=0 amts=0\n[BOTLIVE][VISION RAW] raw_text=\n\n[BOTLIVE][VISION RAW] candidate_amounts=[]\n[BOTLIVE][VISION RAW] detected_objects=['objet:a bag of sanitary wipes on a white background~0.90']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[a bag of sanitary wipes on a white background|90%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:a bag of sanitary wipes on a white background~0.90']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâŒ INSUFFISANT: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.90\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCapture de paiement 2500F\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.90\nğŸ’¾ [HYBRID] RÃ©conciliateur a modifiÃ© notepad â†’ Sauvegarde forcÃ©e\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (339 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:34][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 119s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\nğŸšš [DELIVERY] Zone dÃ©tectÃ©e: Yopougon = 1500 FCFA\nğŸ“‹ [DELIVERY] Contexte injectÃ© dans le prompt (112 chars)\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4267 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4267 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJe suis Ã  Yopougon\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'delivery_zone_date', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (392 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ“ Zone mentionnÃ©e avant: Yopougon (livraison 1500 FCFA)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:40][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 124s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4271 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4271 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nMon numÃ©ro: 0787360757\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: âœ…PARFAIT Commande confirmÃ©e ğŸ˜Š\nLivraison prÃ©vue demain, acompte de 2020 F dÃ©jÃ  versÃ©.\nNous vous rappe...\nğŸ“Š [HYBRID] Source: python_final_recap\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâœ… TÃ©lÃ©phone: 0787360757\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2026 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mMon numÃ©ro: 0787360757\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Mon numÃ©ro: 0787360757\"\nintentions:\n  type: contact\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: \"0787360757\"\n  paiement: null\nnouvelles_donnees:\n  - cle: telephone\n    valeur: \"0787360757\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 50\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: true\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"1/5\"\n  donnees_manquantes: [type_produit, quantite, zone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nQuel produit veux-tu acheter ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 266 | TOTAL: 2026\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001249 ($0.001038 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (421 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ“ Zone mentionnÃ©e avant: Yopougon (livraison 1500 FCFA)\n   ğŸ“ TÃ©lÃ©phone fourni avant: 0787360757\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 136s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nâœ… [VALIDATION] Commande complÃ¨te et validÃ©e !\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4289 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4289 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu modifier le dÃ©lai de livraison ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: âœ…PARFAIT Commande confirmÃ©e ğŸ˜Š\nLivraison prÃ©vue demain, acompte de 2020 F dÃ©jÃ  versÃ©.\nNous vous rappe...\nğŸ“Š [HYBRID] Source: python_final_recap\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâœ… TÃ©lÃ©phone: 0787360757\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2022 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu modifier le dÃ©lai de livraison ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1: question_exacte + intentions\nLa question exacte est \"Peux-tu modifier le dÃ©lai de livraison ?\" et l'intention est de demander une modification du dÃ©lai de livraison.\n\nPHASE 2: deja_collecte + nouvelles_donnees\nNous n'avons pas encore collectÃ© les donnÃ©es nÃ©cessaires pour traiter cette demande. Les donnÃ©es dÃ©jÃ  collectÃ©es sont null.\n\nPHASE 3: verification + confiance\nLa vÃ©rification de la demande est nÃ©cessaire pour dÃ©terminer si la modification du dÃ©lai de livraison est possible. La confiance dans la demande est moyenne.\n\nPHASE 4: check_repetition\nIl n'y a pas de rÃ©pÃ©tition dans la demande.\n\nPHASE 5: completude + prochaine_etape\nLa completude de la demande est de 0/5 et la prochaine Ã©tape est de demander les informations nÃ©cessaires pour traiter la demande.\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mDÃ©solÃ©, mais pour modifier le dÃ©lai de livraison, nous avons besoin de plus d'informations. Pouvez-vous nous donner le numÃ©ro de commande ou le produit exact que vous avez commandÃ© ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1763 | Completion: 259 | TOTAL: 2022\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001245 ($0.001040 input + $0.000205 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n",
      "response": "DÃ©solÃ©, mais pour modifier le dÃ©lai de livraison, nous avons besoin de plus d'informations. Pouvez-vous nous donner le numÃ©ro de commande ou le produit exact que vous avez commandÃ© ?",
      "timestamp": "2025-11-12T22:09:54.251284"
    }
  ],
  "console_output": "ğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=True, Messages=0, Short=True\nğŸ”„ [NOTEPAD] Nouvelle conversation dÃ©tectÃ©e ('Salut ! Je veux commander des ...') - Reset notepad\nâœ… [NOTEPAD] Notepad rÃ©initialisÃ© pour nouvelle commande\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: ğŸš€ Cache prompt global initialisÃ©\n[TRACE][22:07:33][INFO] [PROMPT_CACHE]: âŒ Cache miss: W27PwOPi... | Fetching from DB...\n[SUPABASE] Prompt rÃ©cupÃ©rÃ© (4259 chars)\n[TRACE][22:07:35][INFO] [EMBEDDING_CACHE]: ğŸš€ Cache embedding optimisÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [MODEL_CACHE]: ğŸš€ Cache modÃ¨le global initialisÃ©\n[TRACE][22:07:35][INFO] [UNIFIED_CACHE]: ğŸš€ SystÃ¨me de cache unifiÃ© initialisÃ©\n[TRACE][22:07:35][INFO] [PROMPT_CACHE]: ğŸ“¥ DB fetch: W27PwOPi... | 2595ms | 4259 chars\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ’³ Preuve paiement manquante (OCR non validÃ©, acompte min: 2000 FCFA)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nSalut ! Je veux commander des couches\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâŒ Paiement manquant\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.2s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mSalut ! Je veux commander des couches\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"commander des couches\"\nintentions:\n  type: demande_de_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: type_produit\n    valeur: \"couches\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Clarifier type de couches\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! On a diffÃ©rents types de couches. \nQuel type prÃ©cisÃ©ment ? Couches Ã  pression ou couches culottes ? \nRÃ©ponds pour que l'on puisse te donner le prix exact.\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1762 | Completion: 293 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001040 input + $0.000231 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['created_at', 'products', 'quantities', 'delivery_zone', 'delivery_cost', 'payment_method', 'payment_number', 'phone_number', 'photo_produit', 'paiement', 'calculated_totals', 'last_updated', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (49 chars):\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone, paiement\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:07:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 16s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-2.xx.fbcdn.net/v/t1.15752-9/556908482_1314851517042795_6410429215345539018_n.jpg?_nc_cat=105&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=NL64Tr-lCD8Q7kNvwErQP-W&_nc_oc=Adl-2TTfwDiQ5oV7zD-apLFr6CXVJRBTBS-bGX0OviLygK6yEzKDt_DLemHYyuo4jsHi52BxJLiX6eXRztPxh2Dk&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-2.xx&oh=03_Q7cD3wHQnpKrTBJ4ECMmlxUMRVy5tPvbnhlsvGwaT0Dt2xJwcg&oe=6937FBCA\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 37848\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981673_botlive_g58htsb1.jpg\n[TRACE][22:08:02][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_g58htsb1.jpg\n[BOTLIVE_ENGINE] Initialisation...\n[BOTLIVE_ENGINE] Chargement EasyOCR...\n[BOTLIVE_ENGINE] âœ… EasyOCR chargÃ©\n[BOTLIVE_ENGINE] Chargement BLIP-2...\n[BOTLIVE_ENGINE] âœ… BLIP-2 chargÃ©\n[BOTLIVE_ENGINE] âœ… Initialisation terminÃ©e\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (486, 1080)\n[BLIP-2] ğŸ“ Caption brut: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot'\n[BLIP-2] âœ… Caption nettoyÃ©: 'the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot' (confiance: 0.85)\n[BOTLIVE] BLIP-2 terminÃ©: the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot\n[BOTLIVE] ğŸ’³ Image dÃ©tectÃ©e: PAIEMENT â†’ Analyse OCR...\n[OCR] ğŸ¯ Validation stricte pour numÃ©ro: 0787360757\n[OCR] ğŸ“± Format original: 0787360757\n[OCR] âœ… NumÃ©ro entreprise trouvÃ© dans l'image\n[OCR] ğŸ“‹ 3 transactions dÃ©tectÃ©es\n     â†’ 2020F vers 07 87 36 07 57 le 07 oct\n     â†’ 2020F vers 01 01 53 87 82 le 07 oct\n     â†’ 10100F vers 07 87 36 07 57 le 06 oct\n[OCR] âœ… 2 transaction(s) vers numÃ©ro entreprise\n[OCR] ğŸ¯ Transaction sÃ©lectionnÃ©e: 2020 FCFA vers 07 87 36 07 57 (la plus rÃ©cente)\n[OCR] âœ… Montant validÃ©: 2020 FCFA >= 2000 FCFA\n[BOTLIVE] OCR terminÃ©: 2020 FCFA\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: True\n   Total reÃ§u: 2020 FCFA\n   Paiements: [2020]\n   Message: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\nğŸ’¾ [NOTEPAD] Paiement sauvegardÃ©: 2020 FCFA\nğŸ” [DEBUG] Notepad aprÃ¨s sauvegarde paiement: {'montant': 2020, 'validÃ©': True, 'date': '2025-11-12T22:08:37.134940'}\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s paiement (251 chars)\nğŸ“„ [CONTEXT] Contenu:\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n[BOTLIVE] Analyse (brute): type=unknown, prod=the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot:0.85, ocr_len=381 amts=11\n[BOTLIVE][VISION RAW] raw_text=\n1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 87 36 07 57 \n-2.020F \n07 oct , 11.17 \nÃ€ M ABRAZA 01 01 53 87 82 \n-10.100F \n06 oct , 08.38 \nDe ATTIELO 07 87 36 07 57 \n30.OOOF \n05 oct , 18.12 \nDe ATTIELO 07 87 36 07 57 \n5.0OOF \n05 oot \n1190 \nLenregistrement a Ã©tÃ© sauvegardÃ© \nsouS \nÃ€ EVO MBRA 01 02 34 54 62 \n10.1OOF \n05 oct , 10.32\n[BOTLIVE][VISION RAW] candidate_amounts=[('32.075', ''), ('36 07', ''), ('2.020', ''), ('11.17', ''), ('53 87', ''), ('10.100', ''), ('36 07', ''), ('18.12', ''), ('36 07', ''), ('34 54', ''), ('10.32', '')]\n[BOTLIVE][VISION RAW] detected_objects=['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot|85%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_g58htsb1.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 3\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:the screenshot app screenshot app screenshot apphot apphot apphot apphot apphot apphot~0.85', 'montant:32.075', 'montant:36 07', 'montant:2.020', 'montant:11.17', 'montant:53 87']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = 1215 = > A P \n0 ,l 4,/ % 0 \n32.075F & \nTransfert \nPaiements \nBanque \nCadeaux \nCoffre \nÃ€ ATTIELO 07 8...\n   filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = [{'amount': 2020, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '07 oct'}, {'amount': 2020, 'currency': 'FCFA', 'phone': '01 01 53 87 82', 'date': '07 oct'}, {'amount': 10100, 'currency': 'FCFA', 'phone': '07 87 36 07 57', 'date': '06 oct'}]\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâœ… VALIDÃ‰: âœ… DÃ©pÃ´t validÃ© 2020 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.85\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nVoici la photo du produit\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.85\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Excellent ! Paiement de 2020F bien reÃ§u et validÃ© ğŸ‰\n\nVous Ãªtes dans quelle zone d'Abidjan ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:43][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 67s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4299 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4299 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2033 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mCombien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Combien Ã§a coÃ»te exactement et est-ce nÃ©gociable ?\"\nintentions:\n  type: demande_prix\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBonjour ! Pour te donner un prix exact, j'ai besoin de savoir quel produit tu es intÃ©ressÃ©. Nous avons diffÃ©rents types de couches. Lequel t'intÃ©resse ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1767 | Completion: 266 | TOTAL: 2033\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001253 ($0.001043 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:08:52][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 77s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4297 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4297 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu me donner des conseils sur les tailles ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2055 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu me donner des conseils sur les tailles ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"conseils sur les tailles\"\nintentions:\n  type: demande_d_info\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: demande\n    valeur: \"conseils sur les tailles\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 80\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBien sÃ»r ! ğŸ“¦ Nous avons diffÃ©rentes tailles pour les couches. \nPour mieux vous aider, quel type de couches recherchez-vous ? \nCouches Ã  pression ou couches culottes ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1764 | Completion: 291 | TOTAL: 2055\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001271 ($0.001041 input + $0.000230 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:00][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 84s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4286 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4286 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJ'ai un problÃ¨me technique avec l'app\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2039 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mJ'ai un problÃ¨me technique avec l'app\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"ProblÃ¨me technique avec l'app\"\nintentions:\n  type: demande d'aide\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees:\n  - cle: problÃ¨me\n    valeur: \"technique avec l'app\"\n    confiance: MOYENNE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: true\nconfiance_globale: 40\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT (sans balise):\u001b[0m\n\u001b[92mDÃ©solÃ© pour le problÃ¨me technique. \nQuel type de produit cherches-tu ? \nRÃ©ponds par exemple \"couches\" ou \"lot\".\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 279 | TOTAL: 2039\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001259 ($0.001038 input + $0.000220 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:05][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 89s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“¸ Photo produit manquante ou floue (BLIP-2 non validÃ©)\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4281 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4281 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nOK je continue ma commande alors\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Continuez avec LLM normal...\nğŸ“Š [HYBRID] Source: llm_guide\nğŸ“‹ [HYBRID] Checklist: âŒ Photo manquante\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2009 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mOK je continue ma commande alors\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"OK je continue ma commande alors\"\nintentions:\n  type: continuer_commande\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: null\n  paiement: null\nnouvelles_donnees: []\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 0\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"0/5\"\n  donnees_manquantes: [type_produit, quantite, zone, telephone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mBienvenue ! Pour commencer ta commande, \nquel type de produit veux-tu acheter ? \n(Couches, lot, etc.)\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1758 | Completion: 251 | TOTAL: 2009\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001236 ($0.001037 input + $0.000198 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'calculated_totals', 'conversation_count', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (251 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, photo_produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:12][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 96s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE] TÃ©lÃ©chargement image: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.j...\n[BOTLIVE][FETCH] URL finale: https://scontent-atl3-3.xx.fbcdn.net/v/t1.15752-9/553786504_1339650347521010_7584722332323008254_n.jpg?_nc_cat=108&ccb=1-7&_nc_sid=eb2e90&_nc_ohc=wI6F404RotMQ7kNvwEnhydb&_nc_oc=AdmqrPkDq5bTSUqR3fv3g0PrvQbXW9_9Frci7xyQgQ0werBvu95Sz_8rw99dCA-tpPzw_VcH2vgb6kW0y9q-RJI2&_nc_ad=z-m&_nc_cid=0&_nc_zt=23&_nc_ht=scontent-atl3-3.xx&oh=03_Q7cD3wFOCg_nyFNqiAFZ2JtXL-o6TYQJotUYQ0L6mr8mM1BA7g&oe=6938095A\n[BOTLIVE][FETCH] Content-Type: image/jpeg | Content-Length: 52806\n[BOTLIVE] Image tÃ©lÃ©chargÃ©e: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][DEBUG] Copie image sauvegardÃ©e: /tmp/botlive_debug\\1762981754_botlive_y5ke7tsa.jpg\n[TRACE][22:09:20][INFO] [SUPABASE] Upload: Fichier uploadÃ©: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE][SUPABASE] Image stockÃ©e: https://ilbihprkxcgsigvueeme.supabase.co/storage/v1/object/public/product-images/botlive/W27PwOPiblP8TlOrhPcjOtxd0cza/2025/11/12/botlive_y5ke7tsa.jpg\n[BOTLIVE] âœ… Singleton rÃ©cupÃ©rÃ© (pas de rechargement modÃ¨les)\n[PARALLEL] âœ… NumÃ©ro WAVE: 0787360757\n[BOTLIVE] ğŸ” Analyse image avec BLIP-2 pour dÃ©tection type...\n[BLIP-2] ğŸ” Analyse image: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BLIP-2] ğŸ“¸ Image chargÃ©e: (828, 1792)\n[BLIP-2] ğŸ“ Caption brut: 'a bag of sanitary wipes on a white background'\n[BLIP-2] âœ… Caption nettoyÃ©: 'a bag of sanitary wipes on a white background' (confiance: 0.9)\n[BOTLIVE] BLIP-2 terminÃ©: a bag of sanitary wipes on a white background\n[BOTLIVE] ğŸ“¦ Image dÃ©tectÃ©e: PRODUIT â†’ Pas d'OCR paiement\nğŸ’¾ [NOTEPAD] Photo produit sauvegardÃ©e: a bag of sanitary wipes on a white background\nğŸ”„ [CONTEXT] Contexte mis Ã  jour aprÃ¨s photo produit (314 chars)\n[BOTLIVE][PAYMENT_VALIDATOR] RÃ©sultat validation:\n   Valid: False\n   Total reÃ§u: 0 FCFA\n   Paiements: []\n   Message: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n[BOTLIVE] Analyse (brute): type=unknown, prod=a bag of sanitary wipes on a white background:0.90, ocr_len=0 amts=0\n[BOTLIVE][VISION RAW] raw_text=\n\n[BOTLIVE][VISION RAW] candidate_amounts=[]\n[BOTLIVE][VISION RAW] detected_objects=['objet:a bag of sanitary wipes on a white background~0.90']\n[STATUS] Type: PRODUIT | Statut: ğŸ“¦IMG:OK[a bag of sanitary wipes on a white background|90%] ğŸ’³PAY:ATTENTE\n[BOTLIVE] Fichier temporaire supprimÃ©: C:\\Users\\hp\\AppData\\Local\\Temp\\botlive_y5ke7tsa.jpg\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = ['objet:a bag of sanitary wipes on a white background~0.90']\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = \nğŸ’³ VALIDATION PAIEMENT:\nâŒ INSUFFISANT: Aucun paiement dÃ©tectÃ©. DÃ©pÃ´t requis: 2000 FCFA\n\nâœ… [VALIDATION] Photo produit validÃ©e avec confiance 0.90\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4274 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4274 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nCapture de paiement 2500F\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] Vision result avec vraie confiance: 0.90\nğŸ’¾ [HYBRID] RÃ©conciliateur a modifiÃ© notepad â†’ Sauvegarde forcÃ©e\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: Parfait, j'ai bien votre photo ! ğŸ“¸\n\nDans quelle zone d'Abidjan Ãªtes-vous ? ğŸ“...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâŒ Zone manquante\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (339 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, zone, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:34][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 119s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\nğŸšš [DELIVERY] Zone dÃ©tectÃ©e: Yopougon = 1500 FCFA\nğŸ“‹ [DELIVERY] Contexte injectÃ© dans le prompt (112 chars)\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ Zone livraison manquante\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4267 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4267 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nJe suis Ã  Yopougon\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: NotÃ© ! Livraison Ã  Yopougon â†’ 1500F ğŸšš\nLivraison prÃ©vue demain.\n\nDerniÃ¨re info : votre numÃ©ro de tÃ©lÃ©...\nğŸ“Š [HYBRID] Source: python_auto\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâŒ TÃ©lÃ©phone manquant\nğŸ¯ [HYBRID] Python automatique - RÃ©ponse directe\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'conversation_count', 'delivery_zone_date', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (392 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ“ Zone mentionnÃ©e avant: Yopougon (livraison 1500 FCFA)\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit, tÃ©lÃ©phone\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:40][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 124s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nğŸš¨ [VALIDATION] Ã‰lÃ©ments manquants dÃ©tectÃ©s:\n   âŒ ğŸ“ NumÃ©ro tÃ©lÃ©phone manquant\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4271 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4271 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nMon numÃ©ro: 0787360757\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nğŸ’¾ [HYBRID] DonnÃ©es persistÃ©es: True\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: âœ…PARFAIT Commande confirmÃ©e ğŸ˜Š\nLivraison prÃ©vue demain, acompte de 2020 F dÃ©jÃ  versÃ©.\nNous vous rappe...\nğŸ“Š [HYBRID] Source: python_final_recap\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâœ… TÃ©lÃ©phone: 0787360757\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸ” [HEALTH] Test Groq...\nâœ… [HEALTH] Groq OK (1.0s)\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2026 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mMon numÃ©ro: 0787360757\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1 EXTRACTION\nquestion_exacte: \"Mon numÃ©ro: 0787360757\"\nintentions:\n  type: contact\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: null\n  quantite: null\n  zone: null\n  telephone: \"0787360757\"\n  paiement: null\nnouvelles_donnees:\n  - cle: telephone\n    valeur: \"0787360757\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: false\n  ambiguite: false\nconfiance_globale: 50\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: false\n  quantite: false\n  zone: false\n  telephone: true\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"1/5\"\n  donnees_manquantes: [type_produit, quantite, zone, paiement]\n  prochaine_etape: \"Demander type de produit\"\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nQuel produit veux-tu acheter ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1760 | Completion: 266 | TOTAL: 2026\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001249 ($0.001038 input + $0.000210 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n[HISTORIQUE] âœ… OptimisÃ©: 0 â†’ 0 messages uniques\nğŸ“‹ [NOTEPAD SUPABASE] DonnÃ©es chargÃ©es: ['paiement', 'products', 'created_at', 'quantities', 'last_updated', 'phone_number', 'delivery_cost', 'delivery_zone', 'photo_produit', 'payment_method', 'payment_number', 'blip2_photo_data', 'blip2_photo_date', 'calculated_totals', 'phone_number_date', 'conversation_count', 'delivery_zone_date', 'blip2_photo_verdict', 'last_product_mentioned']\nğŸ” [RESET CHECK] Greeting=False, Messages=0, Short=True\n\n================================================================================\nğŸ” [CONTEXT DEBUG] EXTRACTION DEPUIS HISTORIQUE\n================================================================================\nğŸ“ Historique reÃ§u: 0 chars\nğŸ“ Contenu historique:\n\n================================================================================\n\nâš ï¸ [EXTRACT] Aucune info extraite de l'historique\n\nğŸ§  [CONTEXT] Construction rÃ©sumÃ© intelligent...\nğŸ§  [CONTEXT] RÃ©sumÃ© gÃ©nÃ©rÃ© (421 chars):\n\nğŸ“‹ MÃ‰MOIRE CONVERSATIONS PRÃ‰CÃ‰DENTES (PEUT ÃŠTRE OBSOLÃˆTE):\nâš ï¸ ATTENTION: VÃ©rifier si ces donnÃ©es sont toujours valides pour CETTE conversation\n\n   ğŸ“¸ Photo reÃ§ue avant: DÃ©tectÃ©: objet:a bag of sanitary wipes on a white background~0.90 (conf: 0.90)\n   ğŸ“ Zone mentionnÃ©e avant: Yopougon (livraison 1500 FCFA)\n   ğŸ“ TÃ©lÃ©phone fourni avant: 0787360757\n   ğŸ’³ Paiement reÃ§u avant: ValidÃ© (acompte 2020 FCFA)\n\nâš ï¸ MANQUANT: produit\n\n================================================================================\n\n[BOTLIVE][PROMPT] ğŸ”§ UTILISATION PROMPTS HARDCODÃ‰S (MODE TEST)\n[TRACE][22:09:51][INFO] [PROMPT_CACHE]: âœ… Cache hit: W27PwOPi... | Saved: 1.600s | Age: 136s\nğŸš€ [BOTLIVE_PROMPT] Cache hit! (4259 chars)\n[BOTLIVE][PROMPT] âœ… Prompt Supabase chargÃ© (4259 chars)\n[TRACKING] Demandes ignorÃ©es: Produit=0, Paiement=0\n[BOTLIVE][FILTER] Transactions dÃ©jÃ  filtrÃ©es par OCR: 0\n\n================================================================================\nğŸ” [BOTLIVE][AVANT LLM] DONNÃ‰ES VISION DISPONIBLES:\n   detected_objects = []\n   detected_type = unknown\n   confidence = 0.0\n   raw_text = [vide]...\n   filtered_transactions = []\n   expected_deposit = 2000 (2000 FCFA)\n================================================================================\n\nğŸ”§ [PROMPT MODE] SUPABASE DIRECT\nğŸ” [DEBUG] filtered_transactions = []\nğŸ” [DEBUG] filtered_transactions_str = [AUCUNE TRANSACTION VALIDE]\n\nâœ… [VALIDATION] Commande complÃ¨te et validÃ©e !\nâš ï¸ [PROMPT] Variable manquante dans template: 'context'\nğŸ“Š [SUPABASE PROMPT] FormatÃ©: 4289 chars\n\nğŸ” [BOTLIVE][PROMPT FORMATÃ‰] VÃ©rification injection variables:\n   âœ… {detected_objects} remplacÃ©\n   âœ… {filtered_transactions} remplacÃ©\n\nğŸ“„ [PROMPT EXTRAIT] (500 premiers chars):\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<r...\n\n\n================================================================================\nğŸ” [DEBUG] PROMPT COMPLET ENVOYÃ‰ AU LLM\n================================================================================\nLongueur totale: 4289 chars\n\n--- DÃ‰BUT PROMPT ---\n\n\"\"\"Tu es Jessica, agent IA de RUEDUGROSSISTE.\n\n## CONFIGURATION (NE JAMAIS MODIFIER)\n```\nWHATSAPP: +225 0160924560\nWAVE: +225 0787360757\nACOMPTE: 2000 FCFA\n```\n\n## MISSION\nCollecter 5 donnÃ©es: PRODUIT exact â†’ QUANTITÃ‰ â†’ ZONE â†’ TÃ‰LÃ‰PHONE â†’ PAIEMENT validÃ© OCR\n\n---\n\n## FORMAT OBLIGATOIRE\n\n```xml\n<thinking>\nPHASE 1: question_exacte + intentions\nPHASE 2: deja_collecte + nouvelles_donnees\nPHASE 3: verification + confiance\nPHASE 4: check_repetition\nPHASE 5: completude + prochaine_etape\n</thinking>\n\n<response>\n[AccusÃ© 2-4 mots] [Info + prix si applicable] [Question directive]\n</response>\n```\n\n---\n\n## RÃˆGLES CRITIQUES (ORDRE DE PRIORITÃ‰)\n\n### ğŸš¨ #1: PAIEMENT = \"paid\" INTERDIT SAUF OCR VALIDÃ‰\n\n**CHECKLIST AVANT CHAQUE RÃ‰PONSE:**\n```\nâ–¡ Je vois \"ğŸ“‹ VALIDATION PAIEMENT Status: VALIDÃ‰ âœ…\" ?\n  OUI â†’ paiement: \"paid\" OK\n  NON â†’ paiement: \"pending\" ou null\n\nâ–¡ Client donne tÃ©lÃ©phone ?\n  â†’ paiement RESTE \"pending\" (tÃ©lÃ©phone â‰  paiement)\n\nâ–¡ completude: \"5/5\" ?\n  â†’ Je DOIS avoir paiement: \"paid\" validÃ© OCR\n```\n\n**EXEMPLES INTERDITS:**\n```yaml\n# âŒ FAUX\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"paid\"  # â† ERREUR ! TÃ©lÃ©phone â‰  paiement\ncompletude: \"5/5\"  # â† IMPOSSIBLE !\n\n# âœ… CORRECT\nClient: \"Mon numÃ©ro: 0708123456\"\npaiement: \"pending\"  # â† BON\ncompletude: \"4/5\"  # â† BON, manque paiement\n```\n\n### ğŸš¨ #2: TYPE_PRODUIT DOIT ÃŠTRE EXACT\n\n```yaml\n# âŒ TROP VAGUE\ntype_produit: \"lot 300\"\ntype_produit: \"couches\"\n\n# âœ… PRÃ‰CIS\ntype_produit: \"Couches Ã  pression Taille 3\"\ntype_produit: \"Couches culottes 150\"\n```\n\n### ğŸš¨ #3: LIRE CONTEXTE AVANT REDEMANDER\n\nSi `ğŸ“‹ CONTEXTE COLLECTÃ‰` contient dÃ©jÃ  l'info â†’ NE PAS redemander\n\n---\n\n## STRUCTURE THINKING (YAML 2 ESPACES)\n\n```yaml\nPHASE 1 EXTRACTION\nquestion_exacte: \"texte exact\"\nintentions:\n  type: score\n\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"EXACT ou null\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # \"paid\" UNIQUEMENT si OCR validÃ©\nnouvelles_donnees:\n  - cle: nom\n    valeur: \"valeur\"\n    confiance: HAUTE\n\nPHASE 3 VALIDATION\nverification:\n  prix_trouve: true\n  ambiguite: false\nconfiance_globale: 85\n\nPHASE 4 ANTI_REPETITION\ncheck_repetition:\n  type_produit: true\n  quantite: true\n  zone: false\n  telephone: false\n  paiement: false\n\nPHASE 5 DECISION\nprogression:\n  completude: \"2/5\"\n  donnees_manquantes: [zone, telephone, paiement]\n  prochaine_etape: \"Demander zone\"\n```\n\n---\n\n## EXEMPLES\n\n### Ex1: Client donne tÃ©lÃ©phone\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\ndeja_collecte:\n  type_produit: \"Couches Ã  pression Taille 3\"\n  quantite: 300\n  zone: \"Yopougon\"\n  telephone: \"0708123456\"\n  paiement: \"pending\"  # â† Pas encore validÃ©\n\nPHASE 5 DECISION\nprogression:\n  completude: \"4/5\"\n  donnees_manquantes: [paiement]\n  prochaine_etape: \"Demander capture Wave\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“ NumÃ©ro enregistrÃ©.\nğŸ’³ Envoie la capture de ton dÃ©pÃ´t Wave au +225 0787360757.\n</response>\n```\n\n### Ex2: Paiement validÃ© OCR\n\n```xml\nContexte contient:\nğŸ“‹ VALIDATION PAIEMENT (Botlive OCR)\nStatus: VALIDÃ‰ âœ…\n\n<thinking>\nPHASE 2 COLLECTE\npaiement: \"paid\"  # â† OK car OCR validÃ©\n\nPHASE 5 DECISION\ncompletude: \"5/5\"\nprochaine_etape: \"RÃ©capitulatif\"\n</thinking>\n\n<response>\nSuper ! ğŸ’³ DÃ©pÃ´t confirmÃ©.\nâœ… Commande validÃ©e ! RÃ©capitulatif:\nğŸ“¦ Couches Ã  pression T3 - 22 900 F\nğŸšš Livraison Yopougon - 1500 F\nğŸ’³ Acompte: 2000 F\nğŸ“ Contact: 0708123456\nâ° Livraison: demain\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n</response>\n```\n\n### Ex3: AmbiguÃ¯tÃ© produit\n\n```xml\n<thinking>\nPHASE 2 COLLECTE\nquantite: 300\ntype_produit: null  # â† Pas assez prÃ©cis\n\nPHASE 3 VALIDATION\nambiguite: true\n\nPHASE 5 DECISION\ncompletude: \"1/5\"\nprochaine_etape: \"Clarifier type\"\n</thinking>\n\n<response>\nNotÃ© ! ğŸ“¦ On a 2 types en lot 300:\n- Couches Ã  pression (22 900 F)\n- Couches culottes (24 000 F)\n\nLequel tu veux ?\n</response>\n```\n\n---\n\n## CLÃ”TURE (completude = 5/5)\n\nQuand 5 donnÃ©es collectÃ©es + paiement validÃ© OCR:\n\n```\nâœ… Commande confirmÃ©e ! RÃ©capitulatif:\nğŸ“¦ [Produit exact] - [Prix] F\nğŸšš Livraison [Zone] - [Frais] F\nğŸ’³ Acompte validÃ©: [Montant] F\nğŸ“ Contact: [NumÃ©ro]\nâ° Livraison: [avant 13h = aujourd'hui | aprÃ¨s 13h = demain]\n\nOn te rappelle ! ğŸ˜Š\n\nâš ï¸ NE PAS RÃ‰PONDRE Ã€ CE MESSAGE âš ï¸\n```\n\n---\n\n## ENTRÃ‰E\n\n<<<CONTEXTE>>>\n{context}\n<<<FIN CONTEXTE>>>\n\n<<<QUESTION>>>\nPeux-tu modifier le dÃ©lai de livraison ?\n<<<FIN QUESTION>>>\n\nRÃ‰PONSE:\n\"\"\"\n\n\n--- FIN PROMPT ---\n\n================================================================================\n\nğŸ”„ [HYBRID] SystÃ¨me hybride ACTIVÃ‰ - Traitement avec vision...\nâœ… [HYBRID] RÃ©ponse gÃ©nÃ©rÃ©e: âœ…PARFAIT Commande confirmÃ©e ğŸ˜Š\nLivraison prÃ©vue demain, acompte de 2020 F dÃ©jÃ  versÃ©.\nNous vous rappe...\nğŸ“Š [HYBRID] Source: python_final_recap\nğŸ“‹ [HYBRID] Checklist: âœ… Photo reÃ§ue: \"a bag of sanitary wipes on a white background\"\nâœ… Paiement validÃ©: 2020F (OCR confirmÃ©)\nâœ… Zone: Yopougon (1500F)\nâœ… TÃ©lÃ©phone: 0787360757\nğŸ¤– [HYBRID] LLM guide - Continuer traitement normal\nâœ… [HYBRID] Checklist enrichie injectÃ©e dans prompt LLM\nğŸš€ [SMART] Groq validÃ© - requÃªte rÃ©elle...\nâœ… [SMART] Groq rÃ©ussi - 2022 tokens\n\n================================================================================\n\u001b[94mğŸ”µ QUESTION CLIENT:\u001b[0m\n\u001b[94mPeux-tu modifier le dÃ©lai de livraison ?\u001b[0m\n\n\u001b[93mğŸŸ¡ RAISONNEMENT LLM:\u001b[0m\n\u001b[93mPHASE 1: question_exacte + intentions\nLa question exacte est \"Peux-tu modifier le dÃ©lai de livraison ?\" et l'intention est de demander une modification du dÃ©lai de livraison.\n\nPHASE 2: deja_collecte + nouvelles_donnees\nNous n'avons pas encore collectÃ© les donnÃ©es nÃ©cessaires pour traiter cette demande. Les donnÃ©es dÃ©jÃ  collectÃ©es sont null.\n\nPHASE 3: verification + confiance\nLa vÃ©rification de la demande est nÃ©cessaire pour dÃ©terminer si la modification du dÃ©lai de livraison est possible. La confiance dans la demande est moyenne.\n\nPHASE 4: check_repetition\nIl n'y a pas de rÃ©pÃ©tition dans la demande.\n\nPHASE 5: completude + prochaine_etape\nLa completude de la demande est de 0/5 et la prochaine Ã©tape est de demander les informations nÃ©cessaires pour traiter la demande.\u001b[0m\n\n\u001b[92mğŸŸ¢ RÃ‰PONSE AU CLIENT:\u001b[0m\n\u001b[92mDÃ©solÃ©, mais pour modifier le dÃ©lai de livraison, nous avons besoin de plus d'informations. Pouvez-vous nous donner le numÃ©ro de commande ou le produit exact que vous avez commandÃ© ?\u001b[0m\nâ„¹ï¸ [THINKING] Aucune donnÃ©e extraite du thinking\n\n\u001b[91mğŸ”´ TOKENS RÃ‰ELS GROQ (âœ… Health Check OK):\u001b[0m\n\u001b[91mPrompt: 1763 | Completion: 259 | TOTAL: 2022\u001b[0m\n\u001b[91mğŸ’° COÃ›T: $0.001245 ($0.001040 input + $0.000205 output)\u001b[0m\n\u001b[91mğŸ¤– MODÃˆLE: llama-3.3-70b-versatile\u001b[0m\n================================================================================\n\n"
}