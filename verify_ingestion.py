#!/usr/bin/env python3
"""
Script de v√©rification compl√®te de l'ingestion
V√©rifie que tous les documents sont correctement index√©s et splitt√©s
"""

import requests
import json
from typing import Dict, List

# Configuration
MEILI_URL = "http://127.0.0.1:7700"
COMPANY_ID = "MpfnlSbqwaZ6F4HvxQLRL9du0yG3"

# Donn√©es originales attendues
EXPECTED_DATA = {
    "company_identity": {
        "count": 1,
        "index": "company_docs",
        "keywords": ["RUE_DU_GROS", "gamma", "B√©b√©", "Pu√©riculture"]
    },
    "location_info": {
        "count": 1,
        "index": "localisation",
        "keywords": ["C√¥te d'Ivoire", "Boutique", "ligne"]
    },
    "products_catalog": {
        "count": 19,  # Splitt√©s depuis 1 catalogue
        "index": "products",
        "expected_splits": {
            "Couches √† pression": 7,  # 7 tailles
            "Couches culottes": 6,    # 6 variantes
            "Couches adultes": 6      # 6 variantes
        }
    },
    "delivery": {
        "count": 3,
        "index": "delivery",
        "docs": ["delivery_abidjan_center", "delivery_abidjan_outskirts", "delivery_outside_abidjan"]
    },
    "support_paiement": {
        "count": 2,
        "index": "support_paiement",
        "docs": ["customer_support", "payment_process"]
    },
    "others": {
        "count": 3,
        "index": "company_docs",
        "docs": ["return_policy", "business_summary", "customer_faq"]
    }
}

def query_index(index_name: str) -> Dict:
    """Interroge un index MeiliSearch"""
    url = f"{MEILI_URL}/indexes/{index_name}_{COMPANY_ID}/documents"
    try:
        response = requests.get(url, params={"limit": 1000})
        if response.status_code == 200:
            data = response.json()
            return {
                "success": True,
                "count": len(data.get("results", [])),
                "documents": data.get("results", [])
            }
        else:
            return {"success": False, "error": f"Status {response.status_code}"}
    except Exception as e:
        return {"success": False, "error": str(e)}

def verify_products_split():
    """V√©rifie que les produits sont correctement splitt√©s"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INDEX PRODUCTS")
    print("="*80)
    
    result = query_index("products")
    
    if not result["success"]:
        print(f"‚ùå Erreur: {result['error']}")
        return False
    
    docs = result["documents"]
    count = result["count"]
    
    print(f"\nüìä Total documents: {count}")
    print(f"   Attendu: 19")
    
    if count != 19:
        print(f"   ‚ùå ERREUR: Nombre incorrect !")
        return False
    
    # V√©rifier par produit
    products = {}
    for doc in docs:
        product_name = doc.get("product", "Unknown")
        if product_name not in products:
            products[product_name] = []
        products[product_name].append(doc)
    
    print(f"\nüì¶ Produits trouv√©s:")
    all_good = True
    
    for product_name, product_docs in products.items():
        count = len(product_docs)
        print(f"\n   ‚Ä¢ {product_name}: {count} variantes")
        
        # V√©rifier les prix
        for doc in product_docs[:3]:  # Afficher les 3 premiers
            variant = doc.get("variant", "")
            price = doc.get("price", 0)
            print(f"      - {variant}: {price:,} F CFA".replace(",", "."))
        
        if len(product_docs) > 3:
            print(f"      ... et {len(product_docs) - 3} autres variantes")
    
    # V√©rifier les totaux attendus
    expected = EXPECTED_DATA["products_catalog"]["expected_splits"]
    for product, expected_count in expected.items():
        actual_count = len(products.get(product, []))
        if actual_count != expected_count:
            print(f"   ‚ùå {product}: {actual_count}/{expected_count} variantes")
            all_good = False
        else:
            print(f"   ‚úÖ {product}: {actual_count}/{expected_count} variantes")
    
    return all_good

def verify_delivery():
    """V√©rifie l'index delivery"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INDEX DELIVERY")
    print("="*80)
    
    result = query_index("delivery")
    
    if not result["success"]:
        print(f"‚ùå Erreur: {result['error']}")
        return False
    
    docs = result["documents"]
    count = result["count"]
    
    print(f"\nüìä Total documents: {count}")
    print(f"   Attendu: 3")
    
    if count != 3:
        print(f"   ‚ùå ERREUR: Nombre incorrect !")
        return False
    
    print(f"\nüì¶ Documents trouv√©s:")
    for doc in docs:
        doc_type = doc.get("type", "unknown")
        content_preview = doc.get("content", "")[:80]
        print(f"   ‚Ä¢ {doc_type}")
        print(f"     {content_preview}...")
    
    # V√©rifier que les infos importantes sont pr√©sentes
    all_content = " ".join([doc.get("content", "") for doc in docs])
    keywords = ["Abidjan", "1500", "2000", "3500"]
    
    for keyword in keywords:
        if keyword in all_content:
            print(f"   ‚úÖ '{keyword}' trouv√©")
        else:
            print(f"   ‚ùå '{keyword}' manquant !")
            return False
    
    return True

def verify_support_paiement():
    """V√©rifie l'index support_paiement"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INDEX SUPPORT_PAIEMENT")
    print("="*80)
    
    result = query_index("support_paiement")
    
    if not result["success"]:
        print(f"‚ùå Erreur: {result['error']}")
        return False
    
    docs = result["documents"]
    count = result["count"]
    
    print(f"\nüìä Total documents: {count}")
    print(f"   Attendu: 2")
    
    if count != 2:
        print(f"   ‚ùå ERREUR: Nombre incorrect !")
        return False
    
    print(f"\nüì¶ Documents trouv√©s:")
    for doc in docs:
        doc_type = doc.get("type", "unknown")
        content_preview = doc.get("content", "")[:100]
        print(f"   ‚Ä¢ {doc_type}")
        print(f"     {content_preview}...")
    
    # V√©rifier infos critiques
    all_content = " ".join([doc.get("content", "") for doc in docs])
    keywords = ["+225", "Wave", "2000 FCFA", "WhatsApp"]
    
    for keyword in keywords:
        if keyword in all_content:
            print(f"   ‚úÖ '{keyword}' trouv√©")
        else:
            print(f"   ‚ö†Ô∏è '{keyword}' potentiellement manquant")
    
    return True

def verify_localisation():
    """V√©rifie l'index localisation"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INDEX LOCALISATION")
    print("="*80)
    
    result = query_index("localisation")
    
    if not result["success"]:
        print(f"‚ùå Erreur: {result['error']}")
        return False
    
    docs = result["documents"]
    count = result["count"]
    
    print(f"\nüìä Total documents: {count}")
    print(f"   Attendu: 1")
    
    if count != 1:
        print(f"   ‚ùå ERREUR: Nombre incorrect !")
        return False
    
    doc = docs[0]
    content = doc.get("content", "")
    print(f"\nüì¶ Document:")
    print(f"   {content}")
    
    # V√©rifier infos
    keywords = ["C√¥te d'Ivoire", "ligne"]
    for keyword in keywords:
        if keyword in content:
            print(f"   ‚úÖ '{keyword}' trouv√©")
        else:
            print(f"   ‚ùå '{keyword}' manquant !")
            return False
    
    return True

def verify_company_docs():
    """V√©rifie l'index company_docs (backup global)"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INDEX COMPANY_DOCS (Backup)")
    print("="*80)
    
    result = query_index("company_docs")
    
    if not result["success"]:
        print(f"‚ùå Erreur: {result['error']}")
        return False
    
    docs = result["documents"]
    count = result["count"]
    
    print(f"\nüìä Total documents: {count}")
    print(f"   Attendu: 29 (tous les docs + produits splitt√©s)")
    
    if count != 29:
        print(f"   ‚ö†Ô∏è Attention: Nombre diff√©rent de l'attendu")
    
    # Compter par type
    types = {}
    for doc in docs:
        doc_type = doc.get("type", "unknown")
        types[doc_type] = types.get(doc_type, 0) + 1
    
    print(f"\nüì¶ Documents par type:")
    for doc_type, count in sorted(types.items()):
        print(f"   ‚Ä¢ {doc_type}: {count} docs")
    
    return True

def verify_data_integrity():
    """V√©rifie l'int√©grit√© des donn√©es (aucune alt√©ration)"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION: INT√âGRIT√â DES DONN√âES")
    print("="*80)
    
    # R√©cup√©rer tous les produits
    result = query_index("products")
    if not result["success"]:
        return False
    
    docs = result["documents"]
    
    # V√©rifier des prix sp√©cifiques connus
    known_prices = {
        "17900": "Taille 1 - Couches √† pression",
        "5500": "1 paquet - Couches culottes",
        "25000": "6 paquets - Couches culottes",
        "48000": "12 paquets - Couches culottes",
    }
    
    print("\nüìä V√©rification des prix critiques:")
    for price_str, description in known_prices.items():
        price_int = int(price_str)
        found = any(doc.get("price") == price_int for doc in docs)
        if found:
            print(f"   ‚úÖ {price_int:,} FCFA ({description})".replace(",", "."))
        else:
            print(f"   ‚ùå {price_int:,} FCFA MANQUANT ({description})".replace(",", "."))
            return False
    
    return True

def main():
    """Fonction principale"""
    print("\n" + "="*80)
    print("üîç V√âRIFICATION COMPL√àTE DE L'INGESTION")
    print("="*80)
    print(f"Company ID: {COMPANY_ID}")
    print(f"MeiliSearch: {MEILI_URL}")
    
    results = {
        "Products Split": verify_products_split(),
        "Delivery": verify_delivery(),
        "Support/Paiement": verify_support_paiement(),
        "Localisation": verify_localisation(),
        "Company Docs (Backup)": verify_company_docs(),
        "Data Integrity": verify_data_integrity()
    }
    
    # R√©sum√© final
    print("\n" + "="*80)
    print("üìä R√âSUM√â FINAL")
    print("="*80)
    
    all_pass = True
    for test_name, passed in results.items():
        status = "‚úÖ PASS" if passed else "‚ùå FAIL"
        print(f"{status} - {test_name}")
        if not passed:
            all_pass = False
    
    print("\n" + "="*80)
    if all_pass:
        print("üéâ SUCC√àS: Tous les tests passent !")
        print("‚úÖ Les donn√©es sont correctement index√©es")
        print("‚úÖ Aucune alt√©ration d√©tect√©e")
        print("‚úÖ Split effectu√© correctement")
    else:
        print("‚ùå √âCHEC: Des probl√®mes ont √©t√© d√©tect√©s")
        print("‚ö†Ô∏è V√©rifier les logs ci-dessus")
    print("="*80 + "\n")
    
    return all_pass

if __name__ == "__main__":
    import sys
    success = main()
    sys.exit(0 if success else 1)
