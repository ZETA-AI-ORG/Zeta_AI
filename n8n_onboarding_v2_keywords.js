// INPUT: items = $input.all() (n8n webhook onboarding)
// OUTPUT: [{ json: { company_id, text_documents, purge_before, processed_count } }]

const items = $input.all();

/* ===== MOTS-CL√âS G√âN√âRIQUES PAR TYPE DE DOCUMENT ===== */
const KEYWORDS_BY_TYPE = {
  location: [
    // Localisation / Adresse
    "localisation", "adresse", "o√π √™tes-vous", "o√π vous trouvez", "o√π trouver",
    "emplacement", "situ√©", "situation g√©ographique", "g√©olocalisation",
    // Boutique physique
    "boutique physique", "magasin", "point de vente", "local commercial",
    "boutique en ligne", "e-commerce", "commerce √©lectronique", "vente en ligne",
    "shop", "store", "enseigne", "commerce",
    // Visite / D√©placement
    "se rendre", "venir", "venir sur place", "passer", "visiter", "se d√©placer",
    "passer dans vos locaux", "venir en magasin", "venir au magasin",
    "rendez-vous", "se pr√©senter", "venir vous voir",
    // Structure entreprise
    "si√®ge social", "bureau", "locaux", "√©tablissement", "adresse physique",
    "adresse postale", "coordonn√©es", "o√π √™tes-vous bas√©s"
  ],
  
  delivery: [
    // Livraison g√©n√©rale
    "livraison", "livrer", "livraison √† domicile", "vous livrez", "livraison possible",
    "d√©lai de livraison", "d√©lai", "temps de livraison", "livraison rapide",
    "livraison express", "shipping", "exp√©dition", "envoi",
    // Zones g√©ographiques
    "zones", "zone de livraison", "communes", "quartiers", "secteurs",
    "Abidjan", "Yopougon", "Cocody", "Plateau", "Adjam√©", "Abobo",
    "Marcory", "Koumassi", "Treichville", "Angr√©", "Riviera",
    "Port-Bou√´t", "Att√©coub√©", "Bingerville", "Songon", "Anyama",
    "hors Abidjan", "provinces", "toute la C√¥te d'Ivoire",
    // Frais et tarifs
    "frais de livraison", "co√ªt livraison", "prix livraison", "tarif livraison",
    "frais d'envoi", "frais de transport", "combien co√ªte la livraison",
    "gratuit", "livraison gratuite", "frais offerts"
  ],
  
  product: [
    // Produits g√©n√©raux
    "produit", "article", "item", "marchandise", "r√©f√©rence",
    "catalogue", "gamme", "assortiment", "stock", "inventaire",
    // Caract√©ristiques
    "disponible", "disponibilit√©", "en stock", "rupture de stock",
    "taille", "couleur", "mod√®le", "marque", "type", "version",
    "qualit√©", "description", "caract√©ristiques", "sp√©cifications",
    // Prix et achat
    "prix", "co√ªt", "co√ªte", "combien", "tarif", "montant",
    "acheter", "achat", "commander", "commande", "r√©server",
    "payer", "paiement", "promotion", "offre", "solde", "r√©duction",
    // Variantes
    "variante", "option", "choix", "d√©clinaison", "version",
    "lot", "pack", "paquet", "unit√©", "quantit√©"
  ],
  
  support: [
    // Contact
    "contact", "contacter", "joindre", "t√©l√©phone", "t√©l√©phoner",
    "appeler", "num√©ro", "WhatsApp", "email", "mail",
    "message", "√©crire", "chat", "assistance", "aide",
    // Horaires
    "horaires", "heures d'ouverture", "ouvert", "ferm√©", "disponible",
    "quand", "√† quelle heure", "horaires de service",
    // Support et SAV
    "service client", "support", "assistance", "aide", "question",
    "probl√®me", "r√©clamation", "plainte", "retour", "remboursement",
    "garantie", "SAV", "service apr√®s-vente", "√©change",
    // Paiement
    "payer", "paiement", "modes de paiement", "m√©thodes de paiement",
    "Wave", "Orange Money", "MTN", "Moov", "mobile money",
    "esp√®ces", "cash", "carte bancaire", "virement",
    "acompte", "avance", "paiement anticip√©"
  ]
};

/* ===== Fonction pour ajouter mots-cl√©s au contenu (OBSOL√àTE - gard√©e pour compatibilit√©) ===== */
function addKeywords(content, type) {
  // Cette fonction n'est plus utilis√©e
  // Les mots-cl√©s sont maintenant ajout√©s dans searchable_text
  return content;
}

/* ===== Helpers - Slug & Utils ===== */
function slugifyDash(s) {
  return (s || "doc")
    .toString().trim().toLowerCase()
    .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
    .replace(/[_\s]+/g, "-")
    .replace(/[^a-z0-9-]/g, "")
    .replace(/-+/g, "-")
    .replace(/^-+|-+$/g, "");
}

function slugifyId(s) {
  return String(s || "doc")
    .normalize("NFKD").replace(/[\u0300-\u036f]/g, "")
    .toLowerCase().trim()
    .replace(/[^a-z0-9]+/g, "_")
    .replace(/^_+|_+$/g, "");
}

/* ===== Create text document ===== */
function createDocument(content, fileName, metadata, companyId, addKeywordsFlag = true) {
  if (!metadata.company_id) metadata.company_id = companyId;
  if (!metadata.id) metadata.id = slugifyId(fileName);
  if (!metadata.document_id) metadata.document_id = metadata.id;
  metadata.id_slug = slugifyDash(fileName);
  metadata.id_raw = fileName;
  
  const cleanContent = content.trim();
  
  // Construire le MEGA CHAMP searchable_text
  let searchableText = cleanContent; // Commencer avec le contenu
  
  // Ajouter TOUTES les m√©tadonn√©es importantes au searchable_text
  const metaValues = [];
  
  // Infos g√©n√©rales
  if (metadata.name) metaValues.push(metadata.name);
  if (metadata.ai_name) metaValues.push(metadata.ai_name);
  if (metadata.sector) metaValues.push(metadata.sector);
  if (metadata.zone) metaValues.push(metadata.zone);
  if (metadata.country) metaValues.push(metadata.country);
  
  // Produits
  if (metadata.product_name) metaValues.push(metadata.product_name);
  if (metadata.category) metaValues.push(metadata.category);
  if (metadata.subcategory) metaValues.push(metadata.subcategory);
  if (metadata.price_min) metaValues.push(metadata.price_min + " FCFA");
  if (metadata.price_max) metaValues.push(metadata.price_max + " FCFA");
  if (metadata.variants_count) metaValues.push(metadata.variants_count + " variantes");
  
  // Livraison
  if (metadata.delivery_zone) metaValues.push(metadata.delivery_zone);
  if (metadata.zone_names && Array.isArray(metadata.zone_names)) {
    metaValues.push(...metadata.zone_names);
  }
  if (metadata.price) metaValues.push(metadata.price + " FCFA");
  
  // Contact & Support
  if (metadata.phone) metaValues.push(metadata.phone);
  if (metadata.location_type) metaValues.push(metadata.location_type);
  if (metadata.has_physical_store !== undefined) {
    metaValues.push(metadata.has_physical_store ? "boutique physique" : "en ligne uniquement");
  }
  
  // Paiement
  if (metadata.payment_methods && Array.isArray(metadata.payment_methods)) {
    metaValues.push(...metadata.payment_methods);
  }
  if (metadata.acompte_required) metaValues.push("acompte obligatoire");
  
  // FAQ & autres
  if (metadata.questions_count) metaValues.push(metadata.questions_count + " questions");
  
  // Ajouter les m√©tadonn√©es au searchable_text
  if (metaValues.length > 0) {
    searchableText += " " + metaValues.join(" ");
  }
  
  // ‚ùå MOTS-CL√âS G√âN√âRIQUES SUPPRIM√âS (polluent trop les documents)
  // Le searchable_text contient maintenant UNIQUEMENT:
  // - Le contenu r√©el
  // - Les m√©tadonn√©es importantes (nom, zone, prix, etc.)
  
  return {
    content: cleanContent,  // Contenu PROPRE pour Supabase/LLM
    searchable_text: searchableText,  // MEGA CHAMP optimis√© (sans pollution)
    file_name: fileName,
    metadata: metadata
  };
}

/* ===== Main pipeline ===== */
return items.map((item, idx) => {
  const body = item.json?.body ?? item.json ?? {};
  const company_id = body.company_id || "UNKNOWN_COMPANY";
  const identity = body.identity || {};
  const catalogue = body.catalogue || [];
  const finalisation = body.finalisation || {};
  
  const text_documents = [];
  
  console.log(`üöÄ Processing onboarding for company: ${company_id}`);
  
  // ===== 1. DOCUMENT IDENTIT√â ENTREPRISE =====
  if (identity.companyName) {
    const identityContent = `
IDENTIT√â ENTREPRISE:
Nom: ${identity.companyName}
Assistant IA: ${identity.iaName || 'Assistant'}
Zone d'activit√©: ${identity.activityZone || 'Non sp√©cifi√©'}
Secteur: ${catalogue[0]?.category?.replace('_', ' ') || 'Commerce'}

DESCRIPTION:
${identity.description || ''}

MISSION:
${identity.mission || ''}

OBJECTIF IA:
${identity.iaObjective || 'Assister les clients'}
    `.trim();
    
    text_documents.push(createDocument(
      identityContent,
      `${slugifyDash(identity.companyName)}-identite.txt`,
      {
        type: "company",
        name: identity.companyName,
        ai_name: identity.iaName,
        zone: identity.activityZone,
        sector: catalogue[0]?.category || 'commerce'
      },
      company_id,
      false // Pas de mots-cl√©s pour identit√© (document g√©n√©ral)
    ));
    
    console.log(`‚úÖ Document identit√© cr√©√©`);
  }
  
  // ===== 1.5 DOCUMENT INFOS SUR L'ENTREPRISE (NOUVEAU) =====
  if (identity.companyName && (identity.description || identity.mission)) {
    const infosContent = `
INFORMATIONS SUR L'ENTREPRISE:

üè¢ NOM: ${identity.companyName}
ü§ñ ASSISTANT IA: ${identity.iaName || 'Assistant'}
üåç ZONE D'ACTIVIT√â: ${identity.activityZone || 'C√¥te d\'Ivoire'}
üìä SECTEUR: ${catalogue[0]?.category?.replace('_', ' ') || 'Commerce'}

üìù DESCRIPTION:
${identity.description || 'Non sp√©cifi√©'}

üéØ MISSION:
${identity.mission || 'Non sp√©cifi√©'}

ü§ñ OBJECTIF ASSISTANT IA:
${identity.iaObjective || 'Assister et guider les clients'}

üíº TYPE D'ENTREPRISE:
${finalisation.contact?.hasPhysicalStore ? 'Commerce physique + en ligne' : 'E-commerce 100% en ligne'}
    `.trim();
    
    text_documents.push(createDocument(
      infosContent,
      `${slugifyDash(identity.companyName)}-infos-entreprise.txt`,
      {
        type: "company_info",
        name: identity.companyName,
        ai_name: identity.iaName,
        zone: identity.activityZone,
        sector: catalogue[0]?.category || 'commerce',
        has_description: !!identity.description,
        has_mission: !!identity.mission
      },
      company_id,
      false // Pas de mots-cl√©s pour infos g√©n√©rales
    ));
    
    console.log(`‚úÖ Document infos entreprise cr√©√©`);
  }
  
  // ===== 1.6 DOCUMENT LOCALISATION ENTREPRISE (S√âPAR√â, SANS ZONES DE LIVRAISON) =====
  if (identity.companyName && finalisation.contact) {
    const hasPhysicalStore = finalisation.contact.hasPhysicalStore || false;
    
    const localisationContent = `
LOCALISATION ET ADRESSE ENTREPRISE:

üè¢ NOM: ${identity.companyName}
üìç TYPE: ${hasPhysicalStore ? 'Boutique physique + en ligne' : 'E-commerce 100% en ligne (boutique virtuelle)'}

${hasPhysicalStore ? '‚úÖ BOUTIQUE PHYSIQUE DISPONIBLE' : '‚ùå BOUTIQUE PHYSIQUE: Aucune'}
${!hasPhysicalStore ? '‚ùå MAGASIN PHYSIQUE: Non disponible' : ''}
${!hasPhysicalStore ? '‚ùå POINT DE VENTE: Pas de local commercial' : ''}
${!hasPhysicalStore ? '‚ùå ADRESSE PHYSIQUE: N/A - Uniquement en ligne' : ''}

${!hasPhysicalStore ? 'Vous ne pouvez PAS vous rendre dans nos locaux car nous n\'avons pas de boutique physique.' : ''}
${!hasPhysicalStore ? 'Nous sommes une entreprise exclusivement en ligne.' : ''}

üìû CONTACT:
${finalisation.contact.phone ? `${finalisation.contact.phone}` : 'Non sp√©cifi√©'}
Horaires: ${finalisation.contact.hours || '24/7 (toujours disponible)'}

üåç ZONE D'ACTIVIT√â: ${identity.activityZone || 'C√¥te d\'Ivoire'}
üöö MOD√àLE: ${hasPhysicalStore ? 'Boutique physique + Livraison √† domicile' : 'Livraison √† domicile uniquement'}
    `.trim();
    
    text_documents.push(createDocument(
      localisationContent,
      `${slugifyDash(identity.companyName)}-localisation.txt`,
      {
        type: "localisation",  // ‚úÖ TYPE "localisation" pour routage correct
        name: identity.companyName,
        zone: identity.activityZone,
        country: "C√¥te d'Ivoire",
        has_physical_store: hasPhysicalStore,
        location_type: hasPhysicalStore ? "hybrid" : "online_only",
        phone: finalisation.contact.phone
      },
      company_id,
      true // ‚úÖ AJOUTER MOTS-CL√âS LOCATION
    ));
    
    console.log(`‚úÖ Document localisation cr√©√© (${hasPhysicalStore ? 'HYBRID' : 'ONLINE ONLY'})`);
  }
  
  // ===== 2. DOCUMENTS PRODUITS =====
  if (Array.isArray(catalogue) && catalogue.length > 0) {
    catalogue.forEach((product, pIndex) => {
      if (!product.name) return;
      
      let productContent = `
PRODUIT: ${product.name}
Cat√©gorie: ${product.category?.replace('_', ' ') || 'Non cat√©goris√©'}
Sous-cat√©gorie: ${product.subcategory || 'Aucune'}

VARIANTES ET PRIX:
`;
      
      // Ajouter les variantes
      if (Array.isArray(product.variants) && product.variants.length > 0) {
        product.variants.forEach((variant, vIndex) => {
          productContent += `
${vIndex + 1}. ${variant.name}
   - Prix: ${variant.price?.toLocaleString('fr-FR')} FCFA
   - Quantit√©: ${variant.quantity} ${variant.unit || 'unit√©s'}
   - Prix unitaire: ${variant.pricePerUnit?.toFixed(2)} FCFA/${variant.unit || 'unit√©'}
   ${variant.description ? `- Description: ${variant.description}` : ''}
`;
        });
      }
      
      if (product.usage) {
        productContent += `\nUSAGE:\n${product.usage}`;
      }
      
      if (product.notes) {
        productContent += `\nNOTES IMPORTANTES:\n${product.notes}`;
      }
      
      text_documents.push(createDocument(
        productContent.trim(),
        `produit-${slugifyDash(product.name)}.txt`,
        {
          type: "product",
          product_name: product.name,
          category: product.category,
          subcategory: product.subcategory,
          variants_count: product.variants?.length || 0,
          price_min: Math.min(...(product.variants?.map(v => v.price) || [0])),
          price_max: Math.max(...(product.variants?.map(v => v.price) || [0]))
        },
        company_id,
        true // ‚úÖ AJOUTER MOTS-CL√âS PRODUCT
      ));
    });
    
    console.log(`‚úÖ ${catalogue.length} documents produits cr√©√©s`);
  }
  
  // ===== 3. DOCUMENTS LIVRAISON (3 ZONES S√âPAR√âES) - UNIQUEMENT ZONES, PAS DE LOCALISATION =====
  if (finalisation.delivery) {
    const deliveryText = finalisation.delivery;
    
    // Document 1: Livraison Zones Centrales
    const centralMatch = deliveryText.match(/===\s*LIVRAISON ABIDJAN - ZONES CENTRALES\s*===([\s\S]*?)(?===|$)/i);
    if (centralMatch) {
      const centralContent = `
ZONES DE LIVRAISON - ABIDJAN CENTRE

${centralMatch[1].trim()}

üöö SERVICE: Livraison √† domicile uniquement
üìç COUVERTURE: Zones centrales d'Abidjan
‚è∞ D√âLAI: Commande avant 11h ‚Üí Livraison jour m√™me | Apr√®s 11h ‚Üí Lendemain
      `.trim();
      
      text_documents.push(createDocument(
        centralContent,
        "livraison-zones-centrales.txt",
        {
          type: "livraison",
          delivery_zone: "centre",
          zone_names: ["Yopougon", "Cocody", "Plateau", "Adjam√©", "Abobo", "Marcory", "Koumassi", "Treichville", "Angr√©", "Riviera"],
          price: 1500
        },
        company_id,
        true // ‚úÖ AJOUTER MOTS-CL√âS DELIVERY
      ));
      console.log(`‚úÖ Document livraison ZONES CENTRALES cr√©√©`);
    }
    
    // Document 2: Livraison Zones P√©riph√©riques
    const peripheriqueMatch = deliveryText.match(/===\s*LIVRAISON ABIDJAN - ZONES P√âRIPH√âRIQUES\s*===([\s\S]*?)(?===|$)/i);
    if (peripheriqueMatch) {
      const peripheriqueContent = `
ZONES DE LIVRAISON - ABIDJAN P√âRIPH√âRIE

${peripheriqueMatch[1].trim()}

üöö SERVICE: Livraison √† domicile uniquement
üìç COUVERTURE: Zones p√©riph√©riques d'Abidjan
‚è∞ D√âLAI: Commande avant 11h ‚Üí Livraison jour m√™me | Apr√®s 11h ‚Üí Lendemain
      `.trim();
      
      text_documents.push(createDocument(
        peripheriqueContent,
        "livraison-zones-peripheriques.txt",
        {
          type: "livraison",
          delivery_zone: "peripherie",
          zone_names: ["Port-Bou√´t", "Att√©coub√©", "Bingerville", "Songon", "Anyama", "Brofodoum√©", "Grand-Bassam", "Dabou"],
          price_min: 2000,
          price_max: 2500
        },
        company_id,
        true // ‚úÖ AJOUTER MOTS-CL√âS DELIVERY
      ));
      console.log(`‚úÖ Document livraison ZONES P√âRIPH√âRIQUES cr√©√©`);
    }
    
    // Document 3: Livraison Hors Abidjan
    const horsAbidjanMatch = deliveryText.match(/===\s*EXP√âDITION HORS ABIDJAN\s*===([\s\S]*?)$/i);
    if (horsAbidjanMatch) {
      const horsAbidjanContent = `
ZONES DE LIVRAISON - HORS ABIDJAN (NATIONAL)

${horsAbidjanMatch[1].trim()}

üöö SERVICE: Livraison √† domicile dans toute la C√¥te d'Ivoire
üìç COUVERTURE: Toutes les villes hors Abidjan
‚è∞ D√âLAI: Variable selon la ville (confirmation par t√©l√©phone)
      `.trim();
      
      text_documents.push(createDocument(
        horsAbidjanContent,
        "livraison-hors-abidjan.txt",
        {
          type: "livraison",
          delivery_zone: "national",
          zone_names: ["Hors Abidjan", "Autres villes", "Provinces"],
          price_min: 3500,
          price_max: 5000
        },
        company_id,
        true // ‚úÖ AJOUTER MOTS-CL√âS DELIVERY
      ));
      console.log(`‚úÖ Document livraison HORS ABIDJAN cr√©√©`);
    }
    
    // Fallback: Si le parsing √©choue, cr√©er un document unique
    if (!centralMatch && !peripheriqueMatch && !horsAbidjanMatch) {
      const fallbackContent = `
CONDITIONS DE LIVRAISON:

${deliveryText}

üöö SERVICE: Livraison √† domicile
üìç COUVERTURE: C√¥te d'Ivoire
      `.trim();
      
      text_documents.push(createDocument(
        fallbackContent,
        "livraison-conditions.txt",
        {
          type: "livraison",
          delivery_zone: "all"
        },
        company_id,
        true // ‚úÖ AJOUTER MOTS-CL√âS DELIVERY
      ));
      console.log(`‚úÖ Document livraison UNIQUE cr√©√© (fallback)`);
    }
  }
  
  // ===== 4. DOCUMENT PAIEMENT & SUPPORT =====
  if (finalisation.payment || finalisation.contact) {
    let supportContent = '';
    
    // Section Paiement
    if (finalisation.payment) {
      const payment = finalisation.payment;
      supportContent += `
MODES DE PAIEMENT ACCEPT√âS:
${payment.methods?.join(', ') || 'Non sp√©cifi√©'}

NUM√âROS DE PAIEMENT:
`;
      
      if (payment.numbers) {
        Object.entries(payment.numbers).forEach(([method, number]) => {
          supportContent += `${method.toUpperCase()}: ${number}\n`;
        });
      }
      
      if (payment.acompteRequired) {
        supportContent += `\n‚ö†Ô∏è ACOMPTE OBLIGATOIRE pour valider la commande`;
      }
      
      if (payment.prepaidOnly) {
        supportContent += `\n‚ö†Ô∏è PAIEMENT INT√âGRAL AVANT LIVRAISON`;
      }
    }
    
    // Section Contact
    if (finalisation.contact) {
      const contact = finalisation.contact;
      supportContent += `

CONTACT & SUPPORT:

üìû T√©l√©phone/WhatsApp: ${contact.phone || 'Non sp√©cifi√©'}
‚è∞ Horaires: ${contact.hours || 'Non sp√©cifi√©'}

POLITIQUE DE RETOUR:
${contact.returnPolicy || 'Non sp√©cifi√©'}
      `;
    }
    
    text_documents.push(createDocument(
      supportContent.trim(),
      "paiement-support.txt",
      {
        type: "support",
        phone: finalisation.contact?.phone,
        payment_methods: finalisation.payment?.methods || [],
        acompte_required: finalisation.payment?.acompteRequired || false
      },
      company_id,
      true // ‚úÖ AJOUTER MOTS-CL√âS SUPPORT
    ));
    
    console.log(`‚úÖ Document paiement & support cr√©√©`);
  }
  
  // ===== 5. DOCUMENTS FAQ =====
  if (Array.isArray(finalisation.faq) && finalisation.faq.length > 0) {
    let faqContent = "QUESTIONS FR√âQUENTES (FAQ):\n\n";
    
    finalisation.faq.forEach((item, fIndex) => {
      faqContent += `Q${fIndex + 1}: ${item.question}\nR: ${item.answer}\n\n`;
    });
    
    text_documents.push(createDocument(
      faqContent.trim(),
      "faq.txt",
      {
        type: "faq",
        questions_count: finalisation.faq.length
      },
      company_id,
      false // Pas de mots-cl√©s pour FAQ (d√©j√† question/r√©ponse format)
    ));
    
    console.log(`‚úÖ Document FAQ cr√©√© (${finalisation.faq.length} questions)`);
  }
  
  console.log(`üéâ TOTAL: ${text_documents.length} documents cr√©√©s pour ${company_id}`);
  console.log(`üìä R√©partition: identite=1, infos_entreprise=1, localisation=1, products=${catalogue.length}, delivery=3, support=1, faq=${finalisation.faq?.length || 0}`);
  
  return {
    json: {
      company_id,
      text_documents,
      purge_before: true, // Purge les anciens docs avant d'indexer
      processed_count: text_documents.length,
      original_input: {
        company_name: identity.companyName,
        products_count: catalogue.length,
        timestamp: body.timestamp
      }
    },
    pairedItem: { item: idx }
  };
});
